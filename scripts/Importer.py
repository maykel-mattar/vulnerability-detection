import sys, getopt
import os
from alive_progress import alive_bar
import time

def main(argv):
   print()
   print("********************************************************************************")
   print("**************************                            **************************")
   print("**************************   Representaion Importer   **************************")
   print("**************************                            **************************")
   print("********************************************************************************")
   print()
   filename = ''
   mode = 'all'
   verbose=0
   try:
      opts, args = getopt.getopt(argv,"hvf:m:",["file=","mode="])
   except getopt.GetoptError:
      printHelp()
      sys.exit(2)
   for opt, arg in opts:
      if opt == '-h':
         printHelp()
         sys.exit()
      elif opt == "-v":
         verbose = 1
      elif opt in ("-f", "--file"):
         filename = arg
      elif opt in ("-m", "--mode"):
         mode = arg
   if filename != "" :
      if os.path.isfile(filename):
         progressLength=1
         if mode in ['mixte','all']:
            progressLength=3
         with alive_bar(progressLength,title="Extracting Representations") as bar:
            if mode.lower() in ['mixte', 'all','cfg','cfgpdg','astcfg']:
               ASTO = os.popen('java -jar progex.jar -cfg -lang java  -format json ./'+ filename).read()
               time.sleep(0.002)
               bar()
               if verbose == 1:
                  print(ASTO)
            if mode.lower() in ['mixte', 'all', 'ast','astpdg','astcfg']:
               CFGO = os.popen("java -jar progex.jar -ast -lang java  -format json ./"+ filename).read()
               time.sleep(0.002)
               bar()
               if verbose == 1:
                  print(CFGO)
            if mode.lower() in ['mixte', 'all', 'pdg','cfgpdg','astpdg']:
               PDGO = os.popen("java -jar progex.jar -pdg -lang java  -format json ./"+ filename).read()
               time.sleep(0.002)
               bar()
               if verbose == 1:
                  print(PDGO)
         filename = os.path.splitext(filename)[0]
         if mode.lower() in [ 'all', 'ast']:
            os.system("python ./scripts/AST_Import.py " + filename + "-AST.json")
         if mode.lower() in [ 'all', 'cfg']:
            os.system("python ./scripts/CFG_Import.py  " + filename + "-CFG.json")
         if mode.lower() in [ 'all', 'pdg']:
            os.system("python ./scripts/PDG_DATA_Import.py  " + filename + "-PDG-DATA.json")
         if mode.lower() in [ 'all', 'mixte']:
            os.system("python ./scripts/mixte_Import.py " + filename + "-AST.json " + filename + "-CFG.json")
         if mode.lower() in [ 'all', 'astcfg']:
            os.system("python ./scripts/AST+CFG_Import.py " + filename + "-AST.json " + filename + "-CFG.json")
         if mode.lower() in [ 'all', 'astpdg']:
            os.system("python ./scripts/AST+PDG_Import.py " + filename + "-AST.json " + filename + "-CFG.json")
         if mode.lower() in [ 'all', 'cfgpdg']:
            os.system("python ./scripts/CFG+PDG_Import.py " + filename + "-CFG.json " + filename + "-PDG-DATA.json")
         if mode.lower() not in ['ast','cfg','all','pdg','mixte','cfgpdg','astpdg','astcfg']:
            print("Mode Does Not Exist")
         if mode.lower() in ['mixte', 'all', 'ast']:
            os.remove(filename + "-AST.json")
         if mode.lower() in ['mixte', 'all', 'cfg','cfgpdg']:
            os.remove( filename + "-CFG.json")
         if mode.lower() in ['mixte', 'all', 'pdg','cfgpdg']:
            os.remove(filename + "-PDG-DATA.json")
            os.remove(filename + "-PDG-CTRL.json")

      else:
         print ("'" + filename + "' Not Found!")
   else:
        printHelp()

def printHelp():
    print("-h                                     Show help!", )
    print("-f --file <filename>                   Java file name", )
    print("-m --mode <mode>                       Mode: ALL( By default), AST, CFG, PDG, mixte", )
    print("-v                                     Verbose to get more details in the output", )

if __name__ == "__main__":
   main(sys.argv[1:])
